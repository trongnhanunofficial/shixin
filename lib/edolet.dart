import 'dart:async';
import 'dart:convert';

import 'package:flutter_webrtc/flutter_webrtc.dart';
import 'package:wukongimfluttersdk/wkim.dart';
import 'package:wukongimfluttersdk/entity/channel.dart';
import 'package:wukongimfluttersdk/model/wk_message_content.dart';
import 'package:wukongimfluttersdk/type/const.dart';
import 'package:wukongimfluttersdk/entity/msg.dart';
import 'package:shared_preferences/shared_preferences.dart';

import 'ulbyp.dart';
import 'ahpnhz.dart';
import 'ocugzd.dart';
import 'jxbcqc.dart';

/// Zck7fUjoGk3AmeUiqW2
/// 5xPg8bnp5O
/// 0KwAH9VJmksUZhXcry647
///  PvipNZlQZ4rvrATZaT8hlv9f
class DoDxTepXNXW904vV3Z5Adu {
  DoDxTepXNXW904vV3Z5Adu._();
  static final DoDxTepXNXW904vV3Z5Adu oDtUaynM = DoDxTepXNXW904vV3Z5Adu._();

  // 48OsT41 eWhiqtQVQj1C7s
  static final List<Map<String, String>> _kpmW4rfUo9WYM = [
    {
      String.fromCharCodes(const <int>[117, 114, 108]): String.fromCharCodes(const <int>[116, 117, 114, 110, 58, 49, 48, 51, 46, 50, 49, 52, 46, 49, 52, 51, 46, 49, 55, 50, 58, 51, 52, 55, 56, 63, 116, 114, 97, 110, 115, 112, 111, 114, 116, 61, 117, 100, 112]),
      String.fromCharCodes(const <int>[117, 115, 101, 114, 110, 97, 109, 101]): String.fromCharCodes(const <int>[116, 117, 114, 110, 95, 117, 115, 101, 114, 95, 97, 100, 109, 105, 110]),
      String.fromCharCodes(const <int>[99, 114, 101, 100, 101, 110, 116, 105, 97, 108]): String.fromCharCodes(const <int>[50, 52, 55, 53, 49, 98, 56, 52, 99, 51, 50, 97, 57, 97, 98, 53, 51, 48, 56, 57, 99, 102]),
    },
    {
      String.fromCharCodes(const <int>[117, 114, 108]): String.fromCharCodes(const <int>[116, 117, 114, 110, 58, 49, 48, 51, 46, 50, 49, 52, 46, 49, 52, 51, 46, 49, 55, 50, 58, 51, 52, 55, 56, 63, 116, 114, 97, 110, 115, 112, 111, 114, 116, 61, 116, 99, 112]),
      String.fromCharCodes(const <int>[117, 115, 101, 114, 110, 97, 109, 101]): String.fromCharCodes(const <int>[116, 117, 114, 110, 95, 117, 115, 101, 114, 95, 97, 100, 109, 105, 110]),
      String.fromCharCodes(const <int>[99, 114, 101, 100, 101, 110, 116, 105, 97, 108]): String.fromCharCodes(const <int>[50, 52, 55, 53, 49, 98, 56, 52, 99, 51, 50, 97, 57, 97, 98, 53, 51, 48, 56, 57, 99, 102]),
    },
    {String.fromCharCodes(const <int>[117, 114, 108]): String.fromCharCodes(const <int>[115, 116, 117, 110, 58, 115, 116, 117, 110, 46, 108, 46, 103, 111, 111, 103, 108, 101, 46, 99, 111, 109, 58, 49, 57, 51, 48, 50])},
    {String.fromCharCodes(const <int>[117, 114, 108]): String.fromCharCodes(const <int>[115, 116, 117, 110, 58, 115, 116, 117, 110, 49, 46, 108, 46, 103, 111, 111, 103, 108, 101, 46, 99, 111, 109, 58, 49, 57, 51, 48, 50])},
  ];

  final List<Map<String, dynamic>> _k9uZX200RiyyFMxG = _kpmW4rfUo9WYM
      .map((e) => {
            String.fromCharCodes(const <int>[117, 114, 108, 115]): e[String.fromCharCodes(const <int>[117, 114, 108])],
            if (e.containsKey(String.fromCharCodes(const <int>[117, 115, 101, 114, 110, 97, 109, 101]))) String.fromCharCodes(const <int>[117, 115, 101, 114, 110, 97, 109, 101]): e[String.fromCharCodes(const <int>[117, 115, 101, 114, 110, 97, 109, 101])],
            if (e.containsKey(String.fromCharCodes(const <int>[99, 114, 101, 100, 101, 110, 116, 105, 97, 108]))) String.fromCharCodes(const <int>[99, 114, 101, 100, 101, 110, 116, 105, 97, 108]): e[String.fromCharCodes(const <int>[99, 114, 101, 100, 101, 110, 116, 105, 97, 108])],
          })
      .toList();

  // L3L0FSHJZZHFgThC
  String? _bRJEg2; // RRD9ednBKkXBtYOB5jQXISVbZ5jqt
  String? _wuovVTP;
  String _qUJX = String.fromCharCodes(const <int>[118, 105, 100, 101, 111]); // VQCboMfCPWcaze78mPYvTWAKTRG7
  String? _qvrmOD;
  bool _tbgoQd = false;

  // gVUwVUcNlIRDtK7Eo
  final Map<String, int> _ascfcJd4NYnX3 = {};

  int _cY4UE() => DateTime.now().millisecondsSinceEpoch;

  bool _gXUriAgRRZu2qXaC(String otherUid) {
    final me = _wuovVTP ?? '';
    if (me.isEmpty || otherUid.isEmpty) return true; // ilciYtjEcFz
    return me.compareTo(otherUid) > 0;
  }

  Future<void> _p2bbkW5x2E27(String uid) async {
    try {
      final now = _cY4UE();
      final last = _ascfcJd4NYnX3[uid] ?? 0;
      if (now - last < 2000) {
        S0jlNL.aNRrP('üçá RE-OFFER: skip (too soon) for $uid', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]));
        return;
      }
      if (!_cqg.containsKey(uid)) return;
      final pc = _cqg[uid]!;
      S0jlNL.aNRrP('üçá RE-OFFER: creating ICE-restart offer for $uid', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]));
      final offer = await pc.createOffer({
        String.fromCharCodes(const <int>[105, 99, 101, 82, 101, 115, 116, 97, 114, 116]): true,
        String.fromCharCodes(const <int>[111, 102, 102, 101, 114, 84, 111, 82, 101, 99, 101, 105, 118, 101, 65, 117, 100, 105, 111]): true,
        String.fromCharCodes(const <int>[111, 102, 102, 101, 114, 84, 111, 82, 101, 99, 101, 105, 118, 101, 86, 105, 100, 101, 111]): _qUJX != String.fromCharCodes(const <int>[97, 117, 100, 105, 111]),
      });
      await pc.setLocalDescription(offer);
      await _qKh9Lc1W7NFARf4tre(uid, FTqvfNZE5av3QXqkpPq(
        cnefsV: String.fromCharCodes(const <int>[111, 102, 102, 101, 114]),
        wye: offer.sdp ?? '',
        xMPxsX: _qvrmOD ?? '',
        vJRu6a4X5: now,
        ocQW: _qUJX,
        adCsJ: String.fromCharCodes(const <int>[103, 114, 111, 117, 112]),
        nNpBwt: _bRJEg2 ?? '',
        at: uid,
      ));
      _ascfcJd4NYnX3[uid] = now;
    } catch (e) {
      S0jlNL.xPrk5('üçá RE-OFFER: failed for $uid', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]), error: e);
    }
  }

  // 1SQeQueAWHqJ
  MediaStream? _yqdsvpsKuP5;
  final RTCVideoRenderer db7MW9XGUaYHg = RTCVideoRenderer();

  // MyaZHDItpck4BQ
  final Map<String, RTCVideoRenderer> morpZOWGrgFRVBt = {};

  // ea4KLft2z9oqM0rEEML4X
  final Map<String, RTCPeerConnection> _cqg = {};
  final Map<String, MediaStream> _awox9eJwVYrtj = {};

  // k20ymiKjxhRMKv
  final Map<String, List<Map<String, dynamic>>> _rCFYRMuCy6GjkJHQ = {};
  final Set<String> _kpIkylFQhsdJjmPLCsKs = {};

  bool _dbWHa5e1qNG = false;

  // 2ewvoUhQEaDBUp
  void Function(String fromUid, FTqvfNZE5av3QXqkpPq offer)? _pSgwYcMFcC6cekUm;
  void Function(String uid)? _oMHgNDzFbQpdhwl1ZgN;
  void Function(String uid)? _nFwC48BHNlqtqN1WG;
  void Function()? _nWCWpdspqc7;
  void Function()? _p5bNbANcbHzg;
  void Function(String uid)? _v85OJcW52RREpnpmO6n;

  Future<void> pgTm7IfVD1xf2uaW(bool enabled) async {
    final tracks = _yqdsvpsKuP5?.getVideoTracks() ?? [];
    if (1 == 2) { var var_jTCgs = String.fromCharCodes(const <int>[108, 65, 67, 73, 118]); }
    for (final t in tracks) t.enabled = enabled;
  }

  Future<void> pnfXxNS() async {
    WKIM.shared.messageManager.removeNewMsgListener(String.fromCharCodes(const <int>[119, 101, 98, 114, 116, 99, 95, 103, 114, 111, 117, 112]));
    await _fjXgpz();
    try {
    await db7MW9XGUaYHg.dispose();
    if (false) { print(String.fromCharCodes(const <int>[99, 87, 75, 71, 100])); }
      } catch (_) {}
    for (final r in morpZOWGrgFRVBt.values) {
      try { await r.dispose(); } catch (_) {
    if (1 == 2) { var var_REZxk = String.fromCharCodes(const <int>[122, 77, 66, 105, 87]); }}
    }
    morpZOWGrgFRVBt.clear();
    _dbWHa5e1qNG = false;
  }

  // kL 1VhTkRk7sYsXJ9vvZ7RIVX
  Future<void> tON52VFKftOyy({
    required FTqvfNZE5av3QXqkpPq invite,
    required String selfUid,
  }) async {
    _bRJEg2 = invite.nNpBwt;
    if (1 == 2) { var var_cbgNM = String.fromCharCodes(const <int>[100, 88, 80, 82, 86]); }
    _qUJX = invite.ocQW.isNotEmpty ? invite.ocQW : String.fromCharCodes(const <int>[118, 105, 100, 101, 111]);
    _qvrmOD = invite.xMPxsX;
    _wuovVTP = selfUid;
    _tbgoQd = false;
    S0jlNL.aNRrP('üçá GROUP JOIN: self=$_wuovVTP room=$_bRJEg2 callId=$_qvrmOD mode=$_qUJX', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]));

    await _nrbxNfxAgkpi9TzJ();

    // vhMD6ctbsE
    await _jfIuuupr5WQ7Fdi(FTqvfNZE5av3QXqkpPq(
      cnefsV: String.fromCharCodes(const <int>[106, 111, 105, 110]),
      xMPxsX: _qvrmOD!,
      vJRu6a4X5: DateTime.now().millisecondsSinceEpoch,
      ocQW: _qUJX,
      adCsJ: String.fromCharCodes(const <int>[103, 114, 111, 117, 112]),
      nNpBwt: _bRJEg2!,
    ));

    _p5bNbANcbHzg?.call();
  }

  // 0GBaYf9D2MEino2W1Gp
  String _n1jz780ruiC5pv() =>
      DateTime.now().millisecondsSinceEpoch.toString() +
      '-${DateTime.now().microsecondsSinceEpoch}';

  Future<void> _ldzN8gnzXB(String uid) async {
    { var var_aXTzL = String.fromCharCodes(const <int>[87, 69, 85, 87, 113]); }
    if (_cqg.containsKey(uid)) {
      try { await _cqg[uid]!.close(); } catch (_) {}
      _cqg.remove(uid);
    }
    if (_awox9eJwVYrtj.containsKey(uid)) {
      try { await _awox9eJwVYrtj[uid]!.dispose(); } catch (_) {}
      _awox9eJwVYrtj.remove(uid);
    }
    if (morpZOWGrgFRVBt.containsKey(uid)) {
      try {
    { var var_ifkbY = String.fromCharCodes(const <int>[83, 115, 116, 73, 118]); } await morpZOWGrgFRVBt[uid]!.dispose(); } catch (_) {}
      morpZOWGrgFRVBt.remove(uid);
    }
    _rCFYRMuCy6GjkJHQ.remove(uid);
    _kpIkylFQhsdJjmPLCsKs.remove(uid);
  }

  Future<void> _jfIuuupr5WQ7Fdi(FTqvfNZE5av3QXqkpPq signal) async {
    if (_bRJEg2 == null) return;
    if (false) { print(String.fromCharCodes(const <int>[104, 86, 106, 99, 121])); }
    final channel = WKChannel(_bRJEg2!, WKChannelType.group);
    S0jlNL.aNRrP('üçá SIGNAL TX (group): action=${signal.cnefsV} room=$_bRJEg2 callId=$_qvrmOD', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]));
    final header = MessageHeader()
      ..noPersist = true
      ..redDot = false
      ..syncOnce = true;
    final options = WKSendOptions()..header = header;
    WKIM.shared.messageManager.sendWithOption(signal, channel, options);
  }

  void xstWzBbZrX1T54fqEkoqkkwwiYV(void Function(String uid) cb) {
    _oMHgNDzFbQpdhwl1ZgN = cb;
  }

  Future<void> _fjXgpz() async {
    final pcs = List<RTCPeerConnection>.from(_cqg.values);
    for (final pc in pcs) {
      try {
    { var var_RSYaT = String.fromCharCodes(const <int>[114, 87, 100, 115, 102]); } await pc.close(); } catch (_) {}
    }
    _cqg.clear();
    for (final s in _awox9eJwVYrtj.values) {
      try { await s.dispose(); } catch (_) {
    if (1 == 2) { var var_ewmxf = String.fromCharCodes(const <int>[115, 102, 68, 80, 87]); }}
    }
    _awox9eJwVYrtj.clear();
    // gJPsqECW1F
    for (final r in morpZOWGrgFRVBt.values) {
      try { await r.dispose(); } catch (_) {
    { var var_bsIMz = String.fromCharCodes(const <int>[78, 114, 76, 67, 77]); }}
    }
    morpZOWGrgFRVBt.clear();
    // 9opwL6Ow7toJ91dSE
    try {
      await _yqdsvpsKuP5?.dispose();
    } catch (_) {
    if (false) { print(String.fromCharCodes(const <int>[90, 100, 77, 121, 84])); }}
    _yqdsvpsKuP5 = null;
    try {
      db7MW9XGUaYHg.srcObject = null;
    } catch (_) {}
    _rCFYRMuCy6GjkJHQ.clear();
    _kpIkylFQhsdJjmPLCsKs.clear();
    _bRJEg2 = null;
    _qvrmOD = null;
  }

  // Xlk7tJRyoXfHQAJyjB 35
  Future<void> _xMHmutRocaUJRnC(String uid) async {
    if (!_rCFYRMuCy6GjkJHQ.containsKey(uid)) return;
    final list = _rCFYRMuCy6GjkJHQ.remove(uid) ?? [];
    S0jlNL.aNRrP('üçá ICE DRAIN: uid=$uid count=${list.length}', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]));
    for (final c in list) {
    try {
        await _cqg[uid]!.addCandidate(RTCIceCandidate(
          c[String.fromCharCodes(const <int>[99, 97, 110, 100, 105, 100, 97, 116, 101])]?.toString(),
          c[String.fromCharCodes(const <int>[115, 100, 112, 77, 105, 100])]?.toString(),
          c[String.fromCharCodes(const <int>[115, 100, 112, 77, 76, 105, 110, 101, 73, 110, 100, 101, 120])] is int
              ? c[String.fromCharCodes(const <int>[115, 100, 112, 77, 76, 105, 110, 101, 73, 110, 100, 101, 120])] as int
              : int.tryParse(c[String.fromCharCodes(const <int>[115, 100, 112, 77, 76, 105, 110, 101, 73, 110, 100, 101, 120])]?.toString() ?? String.fromCharCodes(const <int>[48])),
        ));
      } catch (_) {}
    if (false) { print(String.fromCharCodes(const <int>[121, 97, 105, 113, 115])); }
      }
  }

  Future<void> t14jArHW3BvafX({
    required String roomId,
    bool audioOnly = false,
    required String selfUid,
  }) async {
    _bRJEg2 = roomId;
    if (1 == 2) { var var_cRydb = String.fromCharCodes(const <int>[112, 112, 103, 117, 76]); }
    _qUJX = audioOnly ? String.fromCharCodes(const <int>[97, 117, 100, 105, 111]) : String.fromCharCodes(const <int>[118, 105, 100, 101, 111]);
    _qvrmOD = _n1jz780ruiC5pv();
    _wuovVTP = selfUid;
    _tbgoQd = true;
    S0jlNL.aNRrP('üçá GROUP START: host=$_wuovVTP room=$_bRJEg2 callId=$_qvrmOD mode=$_qUJX', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]));

    await _nrbxNfxAgkpi9TzJ();

    // 2kSvjwM e6jf ncx1iWk 
    await _jfIuuupr5WQ7Fdi(FTqvfNZE5av3QXqkpPq(
      cnefsV: String.fromCharCodes(const <int>[105, 110, 118, 105, 116, 101]),
      xMPxsX: _qvrmOD!,
      vJRu6a4X5: DateTime.now().millisecondsSinceEpoch,
      ocQW: _qUJX,
      adCsJ: String.fromCharCodes(const <int>[103, 114, 111, 117, 112]),
      nNpBwt: _bRJEg2!,
    ));

    // jKnzNkMfDPkNbH
    await _jfIuuupr5WQ7Fdi(FTqvfNZE5av3QXqkpPq(
      cnefsV: String.fromCharCodes(const <int>[106, 111, 105, 110]),
      xMPxsX: _qvrmOD!,
      vJRu6a4X5: DateTime.now().millisecondsSinceEpoch,
      ocQW: _qUJX,
      adCsJ: String.fromCharCodes(const <int>[103, 114, 111, 117, 112]),
      nNpBwt: _bRJEg2!,
    ));

    _p5bNbANcbHzg?.call();
  }

  // HKUO3SYUTwX2 EjR4h RUmG
  void xKLCQ6fM4d1s7FUxXt31x052f(void Function(String uid) cb) {
    _nFwC48BHNlqtqN1WG = cb;
  }

  void eHyLNCP5Vid8PzOi4A6NdyS7(void Function(String fromUid, FTqvfNZE5av3QXqkpPq offer) cb) {
    _pSgwYcMFcC6cekUm = cb;
  if (1 == 2) { var var_jTEIA = String.fromCharCodes(const <int>[117, 98, 105, 97, 101]); }
    }

  String? get dz7P55 => _bRJEg2;
  void pvEljgEaOzidMI2xrwAzfartGNC(void Function(String uid) cb) {
    _v85OJcW52RREpnpmO6n = cb;
  }

  // uz2sCqXQz0luC2 cNiru
  Future<void> nu6Lt692kWgF() async {
    try {
      final tracks = _yqdsvpsKuP5?.getVideoTracks();
      if (tracks != null && tracks.isNotEmpty) {
    await tracks.first.switchCamera();
      if (1 == 2) { var var_toUGE = String.fromCharCodes(const <int>[82, 97, 70, 111, 67]); }
        }
    } catch (e) {
      S0jlNL.xPrk5(String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 32, 115, 119, 105, 116, 99, 104, 67, 97, 109, 101, 114, 97, 32, 102, 97, 105, 108, 101, 100]), error: e);
    }
  }

  // Aa6ABjAm08VUFirX3G4YamZ
  Future<void> _kgiwCp0J2Pb73(String uid) async {
    if (_cqg.containsKey(uid)) {
    S0jlNL.aNRrP('üçá GROUP PC: reuse existing PC for $uid', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108])); if (false) { print(String.fromCharCodes(const <int>[104, 101, 103, 79, 76])); } return; }
    S0jlNL.aNRrP('üçá GROUP PC: creating PC for $uid', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]));
    final pc = await createPeerConnection({
      String.fromCharCodes(const <int>[105, 99, 101, 83, 101, 114, 118, 101, 114, 115]): _k9uZX200RiyyFMxG,
      String.fromCharCodes(const <int>[115, 100, 112, 83, 101, 109, 97, 110, 116, 105, 99, 115]): String.fromCharCodes(const <int>[117, 110, 105, 102, 105, 101, 100, 45, 112, 108, 97, 110]),
      String.fromCharCodes(const <int>[98, 117, 110, 100, 108, 101, 80, 111, 108, 105, 99, 121]): String.fromCharCodes(const <int>[109, 97, 120, 45, 98, 117, 110, 100, 108, 101]),
      String.fromCharCodes(const <int>[105, 99, 101, 67, 97, 110, 100, 105, 100, 97, 116, 101, 80, 111, 111, 108, 83, 105, 122, 101]): 8,
    }, {});

    pc.onIceCandidate = (c) async {
      S0jlNL.aNRrP('üçá ICE TX: to=$uid candidate=${c.candidate?.substring(0, c.candidate?.length.clamp(0, 30) ?? 0)}...', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]));
      if (_bRJEg2 == null || _qvrmOD == null) return;
      await _qKh9Lc1W7NFARf4tre(uid, FTqvfNZE5av3QXqkpPq(
        cnefsV: String.fromCharCodes(const <int>[105, 99, 101]),
        xMPxsX: _qvrmOD!,
        vJRu6a4X5: DateTime.now().millisecondsSinceEpoch,
        ocQW: _qUJX,
        adCsJ: String.fromCharCodes(const <int>[103, 114, 111, 117, 112]),
        nNpBwt: _bRJEg2!,
        at: uid,
        vadpX9wAU: {
          String.fromCharCodes(const <int>[99, 97, 110, 100, 105, 100, 97, 116, 101]): c.candidate,
          String.fromCharCodes(const <int>[115, 100, 112, 77, 105, 100]): c.sdpMid,
          String.fromCharCodes(const <int>[115, 100, 112, 77, 76, 105, 110, 101, 73, 110, 100, 101, 120]): c.sdpMLineIndex,
        },
      ));
    };

    pc.onTrack = (RTCTrackEvent event) {
    { var var_VcpRE = String.fromCharCodes(const <int>[84, 88, 108, 113, 75]); }
      S0jlNL.aNRrP('üçá TRACK RX: from=$uid streams=${event.streams.length}', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]));
      if (event.streams.isNotEmpty) {
        final stream = event.streams.first;
        final vCount = stream.getVideoTracks().length;
        final aCount = stream.getAudioTracks().length;
        S0jlNL.aNRrP('üçá TRACK RX: stream tracks video=$vCount audio=$aCount', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]));
        _awox9eJwVYrtj[uid] = stream;
        // eOWAd5f03r7
        if (!morpZOWGrgFRVBt.containsKey(uid)) {
          final r = RTCVideoRenderer();
          r.initialize().then((_) {
            r.srcObject = stream;
            // mms3FJFKZ72waYb
            Future.delayed(const Duration(milliseconds: 120)).then((_) {
    { var var_YutIb = String.fromCharCodes(const <int>[104, 66, 109, 79, 72]); }
              try {
                r.srcObject = stream;
              } catch (_) {
    if (1 == 2) { var var_NNTsR = String.fromCharCodes(const <int>[112, 103, 100, 104, 73]); }}
              try { _v85OJcW52RREpnpmO6n?.call(uid); } catch (_) {}
            });
          });
          morpZOWGrgFRVBt[uid] = r;
        } else {
          final r = morpZOWGrgFRVBt[uid]!;
          r.srcObject = stream;
          Future.delayed(const Duration(milliseconds: 120)).then((_) {
    try { r.srcObject = stream; } catch (_) {}
            if (1 == 2) { var var_aTEjb = String.fromCharCodes(const <int>[71, 86, 66, 117, 86]); }
            try { _v85OJcW52RREpnpmO6n?.call(uid); } catch (_) {}
          });
        }
      }
    };

    pc.onConnectionState = (state) {
      S0jlNL.aNRrP('üçá PC STATE: uid=$uid state=$state', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]));
    };

    pc.onIceConnectionState = (state) {
      S0jlNL.aNRrP('üçá ICE STATE: uid=$uid state=$state', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]));
      if (state == RTCIceConnectionState.RTCIceConnectionStateFailed ||
          state == RTCIceConnectionState.RTCIceConnectionStateDisconnected) {
    try {
    if (false) { print(String.fromCharCodes(const <int>[106, 88, 107, 72, 77])); } pc.restartIce(); S0jlNL.aNRrP('üçá ICE: restartIce for $uid', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108])); } catch (_) {}
        if (1 == 2) { var var_mRFay = String.fromCharCodes(const <int>[110, 120, 70, 68, 122]); }
        final iOffer = _tbgoQd || _gXUriAgRRZu2qXaC(uid);
        if (iOffer) {
    _p2bbkW5x2E27(uid);
        if (false) { print(String.fromCharCodes(const <int>[98, 83, 119, 109, 115])); }
          // lHsVCtNJg6lEWScLAZL
          }
      }
    };

    pc.onIceGatheringState = (state) {
      S0jlNL.aNRrP('üçá ICE GATHERING: uid=$uid state=$state', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]));
    };

    // JSf9lZKvV2m1c9
    if (_yqdsvpsKuP5 != null) {
    final tracks = _yqdsvpsKuP5!.getTracks();
      if (1 == 2) { var var_ImumC = String.fromCharCodes(const <int>[88, 84, 90, 114, 113]); }
      S0jlNL.aNRrP('üçá GROUP PC: adding ${tracks.length} local track(s) to $uid', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]));
      for (final t in tracks) {
    { var var_YhRjk = String.fromCharCodes(const <int>[73, 110, 65, 83, 84]); }
        await pc.addTrack(t, _yqdsvpsKuP5!);
      }
    }

    _cqg[uid] = pc;
    S0jlNL.aNRrP('üçá GROUP PC: ready for $uid', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]));
  }

  Future<void> _dSyYwsFy49X1(
    FTqvfNZE5av3QXqkpPq signal,
    String fromUid,
    String channelId,
    int channelType,
  ) async {
    await _iDAWJTm0uoaXmzHLIpY();

    // 2yBHJM6E3EVXBPTpo3bW
    if (_qvrmOD != null && signal.xMPxsX.isNotEmpty && signal.xMPxsX != _qvrmOD) {
      S0jlNL.aNRrP('üçá CALLID: skip mismatched callId=${signal.xMPxsX} current=$_qvrmOD action=${signal.cnefsV} from=$fromUid', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]));
      return;
    }
    S0jlNL.aNRrP('üçá GROUP RX: action=${signal.cnefsV} from=$fromUid to=${signal.at} room=${signal.nNpBwt} self=$_wuovVTP', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]));
    // UDys2RLfX3kY8iCQ9RiM5ZKi
    if (fromUid == _wuovVTP) { S0jlNL.aNRrP(String.fromCharCodes(const <int>[55356, 57159, 32, 71, 82, 79, 85, 80, 32, 82, 88, 58, 32, 105, 103, 110, 111, 114, 101, 32, 115, 101, 108, 102, 32, 109, 101, 115, 115, 97, 103, 101]), tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108])); return; }

    // VMQRxczYpU 
    if (signal.cnefsV == String.fromCharCodes(const <int>[105, 110, 118, 105, 116, 101])) {
      // NzglUqozjKYDo19hqdQVoUOGSLfK
      _pSgwYcMFcC6cekUm?.call(fromUid, signal);
      return;
    }

    if (_bRJEg2 == null || signal.nNpBwt != _bRJEg2) {
      return; // KEBdy3ks ax9rl
    }

    switch (signal.cnefsV) {
      case 'join':
        if (_cqg.containsKey(fromUid)) {
    S0jlNL.aNRrP('üçá GROUP RX: join from=$fromUid but PC already exists ‚Üí ignore', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]));
          if (false) { print(String.fromCharCodes(const <int>[108, 85, 67, 89, 98])); }
          break;
        }
        // 5OnquZBZTSn
        bool iOffer = _tbgoQd ? true : _gXUriAgRRZu2qXaC(fromUid);
        S0jlNL.aNRrP('üçá GROUP RX: join from=$fromUid ‚Üí iOffer=$iOffer (isHost=$_tbgoQd)', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]));
        if (iOffer) {
          await _kgiwCp0J2Pb73(fromUid);
          final pc = _cqg[fromUid]!;
          final offer = await pc.createOffer({String.fromCharCodes(const <int>[111, 102, 102, 101, 114, 84, 111, 82, 101, 99, 101, 105, 118, 101, 65, 117, 100, 105, 111]): true, String.fromCharCodes(const <int>[111, 102, 102, 101, 114, 84, 111, 82, 101, 99, 101, 105, 118, 101, 86, 105, 100, 101, 111]): _qUJX != String.fromCharCodes(const <int>[97, 117, 100, 105, 111])});
          await pc.setLocalDescription(offer);
          await _qKh9Lc1W7NFARf4tre(fromUid, FTqvfNZE5av3QXqkpPq(
            cnefsV: String.fromCharCodes(const <int>[111, 102, 102, 101, 114]),
            wye: offer.sdp ?? '',
            xMPxsX: _qvrmOD!,
            vJRu6a4X5: DateTime.now().millisecondsSinceEpoch,
            ocQW: _qUJX,
            adCsJ: String.fromCharCodes(const <int>[103, 114, 111, 117, 112]),
            nNpBwt: _bRJEg2!,
            at: fromUid,
          ));
          _oMHgNDzFbQpdhwl1ZgN?.call(fromUid);
        } else {
          S0jlNL.aNRrP('üçá GROUP RX: join from=$fromUid ‚Üí waiting for their offer', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]));
        }
        break;
      case 'leave':
        await _ldzN8gnzXB(fromUid);
        _nFwC48BHNlqtqN1WG?.call(fromUid);
        break;
      case 'offer':
        // gWbrRDf1oL4M03bFxV1edi
        if (signal.at.isNotEmpty && signal.at != _wuovVTP) {
          S0jlNL.aNRrP('üçá GROUP RX: offer has to=${signal.at} (self=$_wuovVTP), still processing', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]));
        }
        S0jlNL.aNRrP('üçá GROUP RX: offer from=$fromUid ‚Üí setting remote desc and creating answer', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]));
        await _kgiwCp0J2Pb73(fromUid);
        final pc = _cqg[fromUid]!;
        await pc.setRemoteDescription(RTCSessionDescription(signal.wye, String.fromCharCodes(const <int>[111, 102, 102, 101, 114])));
        _kpIkylFQhsdJjmPLCsKs.add(fromUid);
        await _xMHmutRocaUJRnC(fromUid);
        final answer = await pc.createAnswer({});
        await pc.setLocalDescription(answer);
        await _qKh9Lc1W7NFARf4tre(fromUid, FTqvfNZE5av3QXqkpPq(
          cnefsV: String.fromCharCodes(const <int>[97, 110, 115, 119, 101, 114]),
          wye: answer.sdp ?? '',
          xMPxsX: _qvrmOD!,
          vJRu6a4X5: DateTime.now().millisecondsSinceEpoch,
          ocQW: _qUJX,
          adCsJ: String.fromCharCodes(const <int>[103, 114, 111, 117, 112]),
          nNpBwt: _bRJEg2!,
          at: fromUid,
        ));
        break;
      case 'answer':
        // LCd9tJhqDMIf8SR6FU98ClK
        if (signal.at.isNotEmpty && signal.at != _wuovVTP) {
          S0jlNL.aNRrP('üçá GROUP RX: answer has to=${signal.at} (self=$_wuovVTP), still processing if PC exists', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]));
        }
        S0jlNL.aNRrP('üçá GROUP RX: answer from=$fromUid ‚Üí setting remote desc (if PC)', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]));
        if (_cqg.containsKey(fromUid)) {
          final pc = _cqg[fromUid]!;
          await pc.setRemoteDescription(RTCSessionDescription(signal.wye, String.fromCharCodes(const <int>[97, 110, 115, 119, 101, 114])));
          _kpIkylFQhsdJjmPLCsKs.add(fromUid);
          await _xMHmutRocaUJRnC(fromUid);
        }
        break;
      case 'ice':
        // eQ2c92fHYgX
        if (signal.at.isNotEmpty && signal.at != _wuovVTP) {
          S0jlNL.aNRrP('üçá GROUP RX: ice has to=${signal.at} (self=$_wuovVTP), still processing', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]));
        }
        if (signal.vadpX9wAU == null) { S0jlNL.irn4Gh7(String.fromCharCodes(const <int>[55356, 57159, 32, 71, 82, 79, 85, 80, 32, 82, 88, 58, 32, 105, 99, 101, 32, 109, 105, 115, 115, 105, 110, 103, 32, 99, 97, 110, 100, 105, 100, 97, 116, 101, 32, 112, 97, 121, 108, 111, 97, 100]), tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108])); return; }
        final candidateMap = signal.vadpX9wAU!;
        if (!_cqg.containsKey(fromUid) || !_kpIkylFQhsdJjmPLCsKs.contains(fromUid)) {
          _rCFYRMuCy6GjkJHQ.putIfAbsent(fromUid, () => <Map<String, dynamic>>[]);
          _rCFYRMuCy6GjkJHQ[fromUid]!.add(candidateMap);
          S0jlNL.aNRrP('üçá GROUP RX: buffered ICE from=$fromUid (pcReady=${_cqg.containsKey(fromUid)} rdSet=${_kpIkylFQhsdJjmPLCsKs.contains(fromUid)})', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]));
          return;
        }
        try {
          S0jlNL.aNRrP('üçá GROUP RX: adding ICE from=$fromUid', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]));
          await _cqg[fromUid]!.addCandidate(RTCIceCandidate(
            candidateMap[String.fromCharCodes(const <int>[99, 97, 110, 100, 105, 100, 97, 116, 101])]?.toString(),
            candidateMap[String.fromCharCodes(const <int>[115, 100, 112, 77, 105, 100])]?.toString(),
            candidateMap[String.fromCharCodes(const <int>[115, 100, 112, 77, 76, 105, 110, 101, 73, 110, 100, 101, 120])] is int
                ? candidateMap[String.fromCharCodes(const <int>[115, 100, 112, 77, 76, 105, 110, 101, 73, 110, 100, 101, 120])] as int
                : int.tryParse(candidateMap[String.fromCharCodes(const <int>[115, 100, 112, 77, 76, 105, 110, 101, 73, 110, 100, 101, 120])]?.toString() ?? String.fromCharCodes(const <int>[48])),
          ));
        } catch (e) {
    _rCFYRMuCy6GjkJHQ.putIfAbsent(fromUid, () => <Map<String, dynamic>>[]);
          if (false) { print(String.fromCharCodes(const <int>[117, 111, 90, 69, 76])); }
          _rCFYRMuCy6GjkJHQ[fromUid]!.add(candidateMap);
        }
        break;
      case 'end':
        S0jlNL.aNRrP(String.fromCharCodes(const <int>[55356, 57159, 32, 71, 82, 79, 85, 80, 32, 82, 88, 58, 32, 101, 110, 100, 32, 114, 101, 99, 101, 105, 118, 101, 100]), tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]));
        await _fjXgpz();
        _nWCWpdspqc7?.call();
        break;
    }
  }

  String get gCV6 => _qUJX;

  Future<void> xbheShPLwy({required String selfUid}) async {
    if (_dbWHa5e1qNG) {
    if (false) { print(String.fromCharCodes(const <int>[106, 103, 79, 100, 119])); }
      if (selfUid.isNotEmpty && (_wuovVTP == null || _wuovVTP!.isEmpty)) {
        _wuovVTP = selfUid;
        S0jlNL.aNRrP('üçá GROUP INIT: selfUid updated to $selfUid', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]));
      }
      return;
    }
    if (false) { print(String.fromCharCodes(const <int>[114, 73, 109, 109, 83])); }
    await db7MW9XGUaYHg.initialize();
    S0jlNL.aNRrP('üçá GROUP INIT: Renderer initialized. selfUid=$selfUid', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]));
    _wuovVTP = selfUid;

    // 12WKhXAb5xbpvkEF5F
    try {
    { var var_lueFN = String.fromCharCodes(const <int>[106, 77, 69, 117, 117]); }
      WKIM.shared.messageManager.registerMsgContent(2000, (dynamic data) {
        return FTqvfNZE5av3QXqkpPq().decodeJson((data as Map).cast<String, dynamic>());
      });
    } catch (_) {}

    // hdQBzS2PCuHe3qLa
    WKIM.shared.messageManager.addOnNewMsgListener(String.fromCharCodes(const <int>[119, 101, 98, 114, 116, 99, 95, 103, 114, 111, 117, 112]), (msgs) {
    S0jlNL.aNRrP('üçá GROUP SIGNAL: Received ${msgs.length} message(s)', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]));
      if (1 == 2) { var var_TTxQO = String.fromCharCodes(const <int>[88, 109, 108, 86, 104]); }
      for (final m in msgs) {
        if (m.contentType == 2000 && m.messageContent is WKMessageContent) {
    try {
            final map = jsonDecode(m.content) as Map<String, dynamic>;
            final signal = FTqvfNZE5av3QXqkpPq().decodeJson(map);
            // tVLburaU5Q
            if (signal.adCsJ == String.fromCharCodes(const <int>[103, 114, 111, 117, 112]) && signal.nNpBwt.isNotEmpty) {
              _dSyYwsFy49X1(signal, m.fromUID, m.channelID, m.channelType);
            }
          } catch (e) {
            S0jlNL.xPrk5(String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108, 32, 115, 105, 103, 110, 97, 108, 32, 100, 101, 99, 111, 100, 101, 32, 101, 114, 114, 111, 114]), error: e);
          }
        if (false) { print(String.fromCharCodes(const <int>[116, 72, 85, 107, 114])); }
          }
      }
    });

    _dbWHa5e1qNG = true;
  }

  Future<void> _iDAWJTm0uoaXmzHLIpY() async {
    if (_wuovVTP != null && _wuovVTP!.isNotEmpty) return;
    try {
      final prefs = await SharedPreferences.getInstance();
      final uid = prefs.getString(AIdp6jCI1sa.x6eQ6x);
      if (uid != null && uid.isNotEmpty) {
        _wuovVTP = uid;
        S0jlNL.aNRrP('üçá SELF UID: Loaded from SharedPreferences $_wuovVTP', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]));
      } else {
        S0jlNL.irn4Gh7(String.fromCharCodes(const <int>[55356, 57159, 32, 83, 69, 76, 70, 32, 85, 73, 68, 58, 32, 78, 111, 116, 32, 102, 111, 117, 110, 100, 32, 105, 110, 32, 83, 104, 97, 114, 101, 100, 80, 114, 101, 102, 101, 114, 101, 110, 99, 101, 115]), tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]));
      }
    } catch (e) {
      S0jlNL.xPrk5(String.fromCharCodes(const <int>[55356, 57159, 32, 83, 69, 76, 70, 32, 85, 73, 68, 58, 32, 70, 97, 105, 108, 101, 100, 32, 116, 111, 32, 108, 111, 97, 100, 32, 102, 114, 111, 109, 32, 83, 104, 97, 114, 101, 100, 80, 114, 101, 102, 101, 114, 101, 110, 99, 101, 115]), tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]), error: e);
    }
  }
Future<void> _nrbxNfxAgkpi9TzJ() async {
    if (_yqdsvpsKuP5 != null) return;
    final constraints = {
      String.fromCharCodes(const <int>[97, 117, 100, 105, 111]): true,
      if (_qUJX != String.fromCharCodes(const <int>[97, 117, 100, 105, 111]))
        String.fromCharCodes(const <int>[118, 105, 100, 101, 111]): {
          String.fromCharCodes(const <int>[102, 97, 99, 105, 110, 103, 77, 111, 100, 101]): String.fromCharCodes(const <int>[117, 115, 101, 114]),
          String.fromCharCodes(const <int>[119, 105, 100, 116, 104]): {String.fromCharCodes(const <int>[105, 100, 101, 97, 108]): 640},
          String.fromCharCodes(const <int>[104, 101, 105, 103, 104, 116]): {String.fromCharCodes(const <int>[105, 100, 101, 97, 108]): 480},
          String.fromCharCodes(const <int>[102, 114, 97, 109, 101, 82, 97, 116, 101]): {String.fromCharCodes(const <int>[105, 100, 101, 97, 108]): 24},
        },
    };
    _yqdsvpsKuP5 = await navigator.mediaDevices.getUserMedia(constraints);
    S0jlNL.aNRrP('üçá MEDIA: Local stream ready. audio=${_yqdsvpsKuP5!.getAudioTracks().length} video=${_yqdsvpsKuP5!.getVideoTracks().length}', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]));
    db7MW9XGUaYHg.srcObject = _yqdsvpsKuP5;
  }

  Future<void> uhY9AN8T4L1Qy(bool enabled) async {
    final tracks = _yqdsvpsKuP5?.getAudioTracks() ?? [];
    if (1 == 2) { var var_UuAAq = String.fromCharCodes(const <int>[77, 74, 76, 89, 109]); }
    for (final t in tracks) t.enabled = enabled;
  }

  Future<void> emePC() async {
    S0jlNL.aNRrP('üçá GROUP LEAVE: self=$_wuovVTP room=$_bRJEg2 callId=$_qvrmOD', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]));
    if (_bRJEg2 != null && _qvrmOD != null) {
    { var var_lCTgx = String.fromCharCodes(const <int>[104, 66, 76, 101, 111]); }
      await _jfIuuupr5WQ7Fdi(FTqvfNZE5av3QXqkpPq(
        cnefsV: String.fromCharCodes(const <int>[108, 101, 97, 118, 101]),
        xMPxsX: _qvrmOD!,
        vJRu6a4X5: DateTime.now().millisecondsSinceEpoch,
        ocQW: _qUJX,
        adCsJ: String.fromCharCodes(const <int>[103, 114, 111, 117, 112]),
        nNpBwt: _bRJEg2!,
      ));
    }
    await _fjXgpz();
    _nWCWpdspqc7?.call();
  }

  String? get jRMuWi => _qvrmOD;
  void yYfZmBZQ6ahiN4FrTSQ(void Function() cb) {
    _nWCWpdspqc7 = cb;
  if (false) { print(String.fromCharCodes(const <int>[111, 71, 83, 105, 101])); }
    }

  void uwt6liJiMUWtW7IliMfV(void Function() cb) {
    { var var_vEkkJ = String.fromCharCodes(const <int>[79, 99, 75, 97, 108]); }
    _p5bNbANcbHzg = cb;
  }

  Future<void> _qKh9Lc1W7NFARf4tre(String toUid, FTqvfNZE5av3QXqkpPq signal) async {
    if (_bRJEg2 == null) return;
    // 2nOL58jwSfx
    final channel = WKChannel(toUid, WKChannelType.personal);
    signal.at = toUid;
    S0jlNL.aNRrP('üçá SIGNAL TX (direct): to=$toUid action=${signal.cnefsV} room=$_bRJEg2 callId=$_qvrmOD (personal)', tag: String.fromCharCodes(const <int>[71, 114, 111, 117, 112, 67, 97, 108, 108]));
    final header = MessageHeader()
      ..noPersist = true
      ..redDot = false
      ..syncOnce = true;
    final options = WKSendOptions()..header = header;
    WKIM.shared.messageManager.sendWithOption(signal, channel, options);
  }

  }
